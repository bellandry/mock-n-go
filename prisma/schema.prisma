generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  members       Member[]
  mocks         MockConfig[]

  invitations Invitation[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String        @id
  expiresAt            DateTime
  token                String
  createdAt            DateTime
  updatedAt            DateTime
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?
  organization         Organization? @relation(fields: [activeOrganizationId], references: [id])

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id          String       @id
  name        String
  slug        String?      @unique
  logo        String?
  metadata    String?
  createdAt   DateTime
  updatedAt   DateTime
  members     Member[]
  invitations Invitation[]
  sessions    Session[]
  mocks       MockConfig[]
  subscription Subscription?

  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime
  updatedAt      DateTime

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  inviter        User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  createdAt      DateTime
  updatedAt      DateTime

  @@unique([organizationId, email])
  @@index([email])
  @@index([organizationId])
  @@map("invitation")
}

model MockConfig {
  id       String @id @default(uuid())
  name     String // Nom descriptif du mock
  basePath String // Le chemin de base (ex: "users", "products")

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Endpoints par méthode HTTP
  endpoints  MockEndpoint[]
  storedData MockData[]

  // Métadonnées générales
  description String?
  isActive    Boolean @default(true)
  accessCount Int     @default(0)

  // Dates
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  expiresAt      DateTime?
  lastAccessedAt DateTime?

  // Rate limiting (free tier: 100 requests/day for entire mock)
  dailyRequestCount Int       @default(0)
  lastRequestDate   DateTime?

  @@unique([organizationId, basePath])
  @@index([organizationId])
  @@index([createdById])
  @@index([isActive])
  @@map("mock_config")
}

model MockEndpoint {
  id           String     @id @default(uuid())
  mockConfigId String
  mockConfig   MockConfig @relation(fields: [mockConfigId], references: [id], onDelete: Cascade)

  // Méthode HTTP
  method HttpMethod // GET, POST, PUT, PATCH, DELETE

  // Configuration spécifique à la méthode
  responseType ResponseType @default(JSON) // JSON, XML, TEXT, HTML
  statusCode   Int          @default(200) // Code de réponse par défaut

  // Pour GET: configuration de la liste
  fields     Json? // Champs à générer (pour GET)
  count      Int?    @default(10)
  pagination Boolean @default(true)

  // Pour POST/PUT/PATCH: validation et réponse
  requestSchema  Json? // Schema de validation du body (JSON Schema)
  responseSchema Json? // Schema de la réponse

  // Comportement
  randomErrors Boolean @default(false)
  errorRate    Int     @default(0)
  delay        Int? // Délai de réponse en ms

  // Custom response (optionnel)
  customResponse Json? // Réponse personnalisée statique

  // Métadonnées
  isActive    Boolean @default(true)
  accessCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mockConfigId, method])
  @@index([mockConfigId])
  @@index([method])
  @@map("mock_endpoint")
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  OPTIONS
  HEAD
}

enum ResponseType {
  JSON
  XML
  TEXT
  HTML
  BINARY
}

model MockData {
  id           String     @id @default(uuid())
  mockConfigId String
  mockConfig   MockConfig @relation(fields: [mockConfigId], references: [id], onDelete: Cascade)

  // Données
  data       Json // Les données soumises
  resourceId String // ID de la ressource (pour PUT/PATCH/DELETE)

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mockConfigId, resourceId])
  @@index([mockConfigId])
  @@index([mockConfigId, resourceId])
  @@map("mock_data")
}

model Subscription {
  id String @id @default(uuid())

  // Relation
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Plan details
  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  // Trial
  trialEndsAt DateTime?
  isTrialing  Boolean  @default(false)

  // Dodo Payments integration
  dodoCustomerId       String? @unique
  dodoSubscriptionId   String? @unique
  dodoProductId        String?
  dodoCheckoutSessionId String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@map("subscription")
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}
